import os
import tensorflow as tf

from DataProcessing.LoadData import dat_to_train_test, to_tf_dataset, rm_unlabelled_samples, to_batch_dataset
from Model.MalwareDetection import MalwareDetection

FILTERED_DATASET_SIZES = 600000

BATCH_SIZE = 500
EPOCHS = 125

# CHECK: Ensure that this is the correct path to the dataset
DATA_DIR = './Data/dat/'

if __name__ == '__main__':
    # Create the instance of the MalwareDetection model
    model = MalwareDetection()

    model.summary()

    x_train, y_train, x_test, y_test = dat_to_train_test(DATA_DIR)

    unfiltered_train_ds = to_tf_dataset(x_train, y_train)
    unfiltered_test_ds = to_tf_dataset(x_test, y_test)

    # Filter out the data with label '-1' (unlabeled)
    filtered_train_ds = rm_unlabelled_samples(unfiltered_train_ds)
    filtered_test_ds = rm_unlabelled_samples(unfiltered_test_ds)

    # val_train_ds = to_batch_dataset(filtered_train_ds, BATCH_SIZE)

    train_ds = filtered_train_ds.take(int(0.85 * FILTERED_DATASET_SIZES))
    val_ds = filtered_train_ds.skip(int(0.85 * FILTERED_DATASET_SIZES))
    test_ds = to_batch_dataset(filtered_test_ds, BATCH_SIZE)

    train_ds = to_batch_dataset(train_ds, BATCH_SIZE)
    val_ds = to_batch_dataset(val_ds, BATCH_SIZE)

    model.train(train_ds,
                validation_dataset=val_ds,
                epochs=EPOCHS,
                optimizer=tf.keras.optimizers.Adam,
                learning_rate=0.000125)

    test_loss, test_acc = model.test(test_ds)

    print(test_loss)
    print(test_acc)
